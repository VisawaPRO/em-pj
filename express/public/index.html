<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Sensor Data</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0e0f20, #1c1c2e);
            color: #e3e3e3;
            overflow: hidden;
            animation: backgroundAnimation 10s infinite alternate;
        }

        @keyframes backgroundAnimation {
            0% { background: linear-gradient(135deg, #0e0f20, #1c1c2e); }
            100% { background: linear-gradient(135deg, #1c1c2e, #0e0f20); }
        }

        h1 {
            text-align: center;
            color: #00ffcc;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ffcc;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            perspective: 1000px;
            margin-bottom: 20px;
        }

        #sensorData, #temperatureChart {
            padding: 20px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 2px solid #00ffcc;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 255, 204, 0.3);
            flex: 1;
            transform: rotateY(0deg);
            transition: transform 0.5s;
        }

        #sensorData:hover, #temperatureChart:hover {
            transform: rotateY(10deg);
        }

        .section-header {
            text-align: center;
            font-size: 1.5em;
            margin: 20px 0;
            padding: 10px;
            border: 2px solid #00ffcc;
            border-radius: 10px;
            background-color: rgba(0, 255, 204, 0.1);
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
        }

        .sensor-value {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }

        .hot {
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
        }

        .normal {
            background-color: rgba(0, 255, 0, 0.7);
            color: white;
        }

        .cold {
            background-color: rgba(0, 0, 255, 0.7);
            color: white;
        }

        #temperatureTable {
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            border-collapse: collapse;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
        }

        #temperatureTable th, #temperatureTable td {
            padding: 10px;
            border: 1px solid rgba(0, 255, 204, 0.5);
            text-align: center;
        }

        #temperatureTable th {
            background-color: rgba(0, 255, 204, 0.3);
        }

        .glow {
            text-shadow: 0 0 20px rgba(255, 255, 255, 1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>ESP32 Sensor Data üìä</h1>
    <div class="container">
        <div id="sensorData">Loading sensor data...</div>
        <div id="temperatureChart">
            <canvas id="temperatureChartCanvas"></canvas>
        </div>
    </div>

    <div class="section-header">üå°Ô∏è Daily Average Temperature</div>
    <table id="temperatureTable">
        <thead>
            <tr>
                <th>Day</th>
                <th>Average Temperature (¬∞C)</th>
            </tr>
        </thead>
        <tbody>
            <tr id="averageTemperatureRow">
                <td id="currentDay"></td>
                <td id="averageTemperature">N/A</td>
            </tr>
        </tbody>
    </table>

    <script>
        const sensorDataDiv = document.getElementById('sensorData');
        const temperatureTableBody = document.querySelector('#temperatureTable tbody');
        const currentDayCell = document.getElementById('currentDay');
        const averageTemperatureCell = document.getElementById('averageTemperature');
        const ctx = document.getElementById('temperatureChartCanvas').getContext('2d');

        let hourlyTemperatures = {};
        let dailyAverages = {};
        let temperatureData = [];
        let humidityData = [];
        let labels = [];
        let lastFetchTime = new Date();
        let lastChartUpdate = new Date();

        // Initialize Chart.js
        const temperatureChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperature (¬∞C) üå°Ô∏è',
                        data: temperatureData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Humidity (%) üíß',
                        data: humidityData,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time ‚è∞',
                            color: 'white',
                            font: {
                                size: 14,
                                weight: 'bold',
                                family: 'Courier New'
                            }
                        },
                        ticks: {
                            color: 'white'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value',
                            color: 'white',
                            font: {
                                size: 14,
                                weight: 'bold',
                                family: 'Courier New'
                            }
                        },
                        min: 0,
                        ticks: {
                            color: 'white'
                        }
                    }
                }
            }
        });

        const fetchUrl = 'http://192.168.1.119:3300/sensor-data'; // Change this to your actual API endpoint
        const apiKey = 'Bearer z9LRcZFD09RzMdFJg0OwInK9iMhldA90Tz9h9XXc2rsTrPGmRhMRP06sq4JNXhiLUkrXyS63Nx';

        // Function to calculate heat index
        function calculateHeatIndex(temperature, humidity) {
            const c1 = -42.379;
            const c2 = 2.04901523;
            const c3 = 10.14333127;
            const c4 = -0.22475541;
            const c5 = -6.83783 * Math.pow(10, -3);
            const c6 = -5.481717 * Math.pow(10, -2);
            const c7 = 1.22874 * Math.pow(10, -3);
            const c8 = 8.5282 * Math.pow(10, -4);
            const c9 = -1.99 * Math.pow(10, -6);

            return c1 + (c2 * temperature) + (c3 * humidity) + (c4 * temperature * humidity) +
                (c5 * Math.pow(temperature, 2)) + (c6 * Math.pow(humidity, 2)) +
                (c7 * Math.pow(temperature, 2) * humidity) + (c8 * temperature * Math.pow(humidity, 2)) +
                (c9 * Math.pow(temperature, 2) * Math.pow(humidity, 2));
        }

        // Function to update the sensor data display
        function updateSensorData(temperature, humidity) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();

            // Update sensor data display
            sensorDataDiv.innerHTML = `
                <div class="sensor-value">Temperature: <span class="temp">${temperature} ¬∞C</span></div>
                <div class="sensor-value">Humidity: <span class="humidity">${humidity}%</span></div>
                <div class="sensor-value">Time: ${timeString}</div>
            `;

            // Calculate heat index and update status
            const heatIndex = calculateHeatIndex(temperature, humidity);
            let status = '';

            if (heatIndex > 30) {
                status = `<span class="status hot">Status : Hotüî•</span>`;
            } else if (heatIndex < 20) {
                status = `<span class="status cold">Status : Cold‚ùÑÔ∏è</span>`;
            } else {
                status = `<span class="status normal">Status : Normalüòä</span>`;
            }

            sensorDataDiv.innerHTML += status;

            // Update chart data
            if (now - lastChartUpdate > 60000) { // Update chart every minute
                temperatureChart.data.labels.push(timeString);
                temperatureChart.data.datasets[0].data.push(temperature);
                temperatureChart.data.datasets[1].data.push(humidity);
                temperatureChart.update();
                lastChartUpdate = now;
            }

            // Update hourly temperature tracking
            const currentHour = now.getHours();
            if (!hourlyTemperatures[currentHour]) {
                hourlyTemperatures[currentHour] = [];
            }
            hourlyTemperatures[currentHour].push(temperature);

            // Update daily averages
            const today = now.toLocaleDateString();
            if (!dailyAverages[today]) {
                dailyAverages[today] = { total: 0, count: 0 };
            }
            dailyAverages[today].total += temperature;
            dailyAverages[today].count += 1;

            // Update the average temperature row
            currentDayCell.innerText = today;
            averageTemperatureCell.innerText = (dailyAverages[today].total / dailyAverages[today].count).toFixed(2);
        }

        // Fetch data from the API
        async function fetchData() {
            try {
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: { 'Authorization': apiKey }
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const temperature = data.temperature;
                const humidity = data.humidity;

                updateSensorData(temperature, humidity);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Initial fetch and set interval for data fetching
        fetchData();
        setInterval(fetchData, 10000); // Fetch data every 10 seconds
    </script>
</body>
</html>
